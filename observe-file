#!/bin/bash
# Time-stamp: <2012-10-19 13:28:02 JST, hirose31>
#
# ファイルやディレクトリが更新されたら任意のコマンドを実行する
#

prog=${0##*/}
basedir=${0%/*}

die() { echo "[ABORT] $@"; exit 1; }

usage() {
  [ -z "$@" ] || echo "[error] $@" 1>&2
  cat <<EOUSAGE
[usage]
  $prog [-h?] -c COMMAND FILE|DIR [ FILE|DIR ] ...
  $prog [-h?] -x FILE
    -h -?  help
EOUSAGE
  exit 2
}

command=
observe_targets=

OPTIND_OLD=$OPTIND
OPTIND=1
while getopts "h?c:x:" opt; do
  case $opt in
    c)
      command=$OPTARG
      observe_targets='' # あとで入れる
      ;;
    x)
      command=$OPTARG
      observe_targets=$command
      ;;
    ?|h)
      usage
      ;;
  esac
done
shift $(($OPTIND - 1))
OPTIND=$OPTIND_OLD

if [ -z "$observe_targets" ]; then
  observe_targets="$@"
fi
if [ -z "$observe_targets" ]; then
  usage "missing arguments"
fi

wait_for_change() {
  inotifywait -r \
    -e 'close_write,create,delete' \
    --excludei '(.*\.swp$|\.git/|service/|\.#.*|.*~$)' \
    "$@" 2>/dev/null
}

# echo "target : $observe_targets"
# echo "command: $command:"

while wait_for_change $observe_targets; do
  echo ">> "
  bash -c "$command"
  echo "<< "
done

