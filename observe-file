#!/bin/bash
#
# perform arbitrary command when change file or directory
#

prog=${0##*/}
basedir=${0%/*}

die() { echo "[ABORT] $@"; exit 1; }

usage() {
  [ -z "$@" ] || echo "[error] $@" 1>&2
  cat <<EOUSAGE
[usage]
  $prog [-1] [-h?] -c COMMAND FILE|DIR [ FILE|DIR ] ...
  $prog [-1] [-h?] -x FILE
    -1     oneshot
    -h -?  help
EOUSAGE
  exit 2
}

command=
observe_targets=
oneshot=

OPTIND_OLD=$OPTIND
OPTIND=1
while getopts "h?c:x:" opt; do
  case $opt in
    c)
      command=$OPTARG
      observe_targets='' # set later
      ;;
    x)
      command=$OPTARG
      observe_targets=$command
      ;;
    1)
      oneshot=1
      ;;
    ?|h)
      usage
      ;;
  esac
done
shift $(($OPTIND - 1))
OPTIND=$OPTIND_OLD

if [ -z "$observe_targets" ]; then
  observe_targets="$@"
fi
if [ -z "$observe_targets" ]; then
  usage "missing arguments"
fi

wait_for_change() {
  inotifywait -r \
    -e 'close_write,create,delete' \
    --excludei '(.*\.swp$|\.git/|service/|\.#.*|.*~$|_flymake)' \
    "$@" 2>/dev/null
}

# echo "target : $observe_targets"
# echo "command: $command:"

echo ">> "
bash -c "$command"
echo "<< "
[ ! -z "$oneshot" ] && exit

while wait_for_change $observe_targets; do
  echo ">> "
  bash -c "$command"
  echo "<< "
done

